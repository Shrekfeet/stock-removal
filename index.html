<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#76b729">
  <title>Workshop Stock Form</title>

  <!-- Fonts & Choices.js -->
  <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    :root{
      --green:#76b729;
      --green-600:#54851c;
      --green-700:#406516;
      --mint:#eaf6db;
      --brown:#784e2f;
      --bg:#f5f7f9;
      --surface:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --field:#f9fafb;
      --border:#e5e7eb;
      --radius:14px;
      --shadow:0 6px 18px rgba(16,24,40,.08);
      --shadow-soft:0 2px 8px rgba(16,24,40,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1418;
        --surface:#121a21;
        --text:#e5e7eb;
        --muted:#9aa3af;
        --field:#0f1418;
        --border:#22303b;
        --shadow:0 10px 28px rgba(0,0,0,.45);
        --shadow-soft:0 2px 10px rgba(0,0,0,.35);
      }
    }

    /* Layout */
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Domine',serif;
      color:var(--text);
      background:var(--bg);
    }
    .wrap{
      max-width:720px;
      margin-inline:auto;
      padding:clamp(16px,3vw,28px);
    }

    /* Header */
    .logo{
      display:block;
      max-width:160px;
      width:50%;
      min-width:140px;
      margin: 8px auto 6px;
      height:auto;
      filter: drop-shadow(var(--shadow-soft));
    }
    h1{
      margin:0 0 12px 0;
      text-align:center;
      font-size:clamp(22px,4.5vw,30px);
      color:var(--green-600);
      letter-spacing:.2px;
    }
    .subtle{
      text-align:center;
      color:var(--muted);
      margin:0 0 18px;
      font-size:14px;
    }

    /* Card */
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(14px,3.5vw,24px);
    }

    /* Form grid */
    .row{
      display:grid;
      gap:12px;
    }
    .row--split{
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width:640px){
      .row--split{ grid-template-columns: 2fr 1fr; }
    }
    /* Prevent overflow on small screens (fixes date input overflow) */
    .row > * { min-width: 0; }

    label{
      font-weight:700;
      color:var(--green-700);
      margin: 6px 0 6px;
      display:block;
    }
    .help{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    input, .choices__inner{
      width:100%;
      min-width:0; /* critical for mobile overflow */
      height:50px;
      padding:12px 14px;
      font-size:16px;
      font-family:'Domine',serif;
      background:var(--field);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      box-sizing:border-box;
      transition:border-color .2s, box-shadow .2s, background .2s;
      -webkit-tap-highlight-color: transparent;
    }
    input:focus, .choices__inner:focus-within{
      outline:none;
      border-color:var(--green);
      box-shadow:0 0 0 3px rgba(118,183,41,.25);
      background:#fff;
    }

    /* iOS/WebKit date input quirks: keep it inside container */
    input[type="date"]{
      appearance: none;
      -webkit-appearance: none;
      width:100%;
      overflow:hidden;   /* prevents native icon from pushing width */
      text-overflow: ellipsis;
    }
    input[type="date"]::-webkit-date-and-time-value { text-align:left; }
    input[type="date"]::-webkit-calendar-picker-indicator{
      cursor:pointer;
    }

    /* Choices tweaks */
    .choices{ margin-top:6px; font-size:16px; }
    .choices__inner{ min-height:50px; display:flex; align-items:center; }
    .choices.is-open .choices__inner{ border-radius:12px 12px 0 0; }
    .choices__list--dropdown, .choices__list[aria-expanded]{
      border:1px solid var(--border);
      border-top:none;
      background:#fff;
      font-size:16px;
      border-radius:0 0 12px 12px;
      max-height:280px;
      overflow:auto;
    }
    .choices__item--selectable{ padding:10px 12px; }
    .choices__item--selectable.is-highlighted{
      background: var(--mint);
      color: var(--green-700) !important;
    }

    .choices__list--dropdown .choices__item,
    .choices__list[aria-expanded] .choices__item {
      color: var(--green-600) !important; /* or use var(--green) if you prefer the brighter green */
    }

    /* Product block */
    .product{
      border:1px solid var(--border);
      background:var(--surface);
      border-radius:12px;
      padding:14px;
      margin-top:12px;
      box-shadow:var(--shadow-soft);
    }
    .product__title{
      font-weight:700;
      margin:0 0 6px;
      font-size:15px;
      color:var(--brown);
    }

    /* Buttons */
    .btn{
      margin-top:16px;
      padding:14px 16px;
      font-size:16px;
      border:none;
      background:var(--green);
      color:#fff;
      font-weight:800;
      border-radius:14px;
      width:100%;
      cursor:pointer;
      transition:transform .05s ease, filter .2s, background .2s;
      box-shadow: var(--shadow-soft);
    }
    .btn:hover{ background:var(--green-600); }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Messages */
    .msg{
      margin-top:14px;
      padding:12px 14px;
      border-radius:12px;
      font-size:14px;
      border:1px solid var(--border);
      background: #fff;
    }
    .msg--warn{ background: var(--mint); border-color: var(--green); color:#1d3a10; }
    .msg--error{ background:#fde7e7; border-color:#ffb4b4; color:#7f1d1d; }
    .msg--ok{ background:#e6f6ea; border-color:#a9e1bc; color:#0f5132; }

    /* Footer note */
    .footer-note{
      text-align:center;
      color:var(--muted);
      margin-top:16px;
      font-size:12px;
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <img src="Shrekfeet Logo.png" alt="Shrekfeet Logo" class="logo" />
    <h1>Workshop Stock Exchange Form</h1>
    <p class="subtle">Fill out your name, date, and up to five items to remove from stock.</p>

    <form id="stockForm" class="card" novalidate>
      <div class="row">
        <div>
          <label for="technician">Technician Name</label>
          <input id="technician" name="technician" type="text" placeholder="e.g., Alex Brown" autocomplete="name" required/>
          <div class="help">Required</div>
        </div>

        <div>
          <label for="date">Date</label>
          <input id="date" name="date" type="date" required/>
        </div>
      </div>

      <div id="productFields" aria-live="polite" aria-busy="true">
        <div class="msg" id="loadingMsg">Loading product list…</div>
      </div>

      <p id="limitMessage" class="msg msg--warn" style="display:none;">
        You’ve reached the 5-item limit. If you need to remove more items, please submit another form.
      </p>

      <div id="formMsg" class="msg" style="display:none;"></div>

      <button id="submitBtn" class="btn" type="submit" disabled>Submit</button>

      <p class="footer-note">All submissions are sent securely.</p>
    </form>
  </div>

  <script>
  (function(){
    const sheetID   = '1Mbtodjvs9m1QgzQPX18j8FnmlAzfKxxbGx8O6XUkySI';
    const webhookURL= 'https://hook.eu2.make.com/txaiit01opb9nhhre5ly9sju2a885ra4';
    const maxItems  = 5;

    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$= (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    const form = $('#stockForm');
    const dateInput = $('#date');
    const productFields = $('#productFields');
    const submitBtn = $('#submitBtn');
    const formMsg = $('#formMsg');
    const limitMessage = $('#limitMessage');

    // Autofill today's date
    dateInput.valueAsDate = new Date();

    // Helpers
    const showMsg = (el, text, type='')=>{
      el.textContent = text;
      el.className = 'msg' + (type ? ' msg--' + type : '');
      el.style.display = text ? 'block' : 'none';
    };

    const makeProductBlock = (index, optionsHTML) => {
      const wrap = document.createElement('div');
      wrap.className = 'product';
      wrap.style.display = index === 0 ? 'block' : 'none';
      wrap.innerHTML = `
        <p class="product__title">Item ${index + 1}</p>
        <div class="row row--split">
          <div>
            <label for="product${index}">Product</label>
            <select id="product${index}" name="product${index}" aria-label="Product ${index + 1}">
              <option value="">-- Select a product --</option>
              ${optionsHTML}
            </select>
          </div>
          <div>
            <label for="quantity${index}">Quantity</label>
            <input id="quantity${index}" name="quantity${index}" type="number" inputmode="numeric" min="1" step="1" placeholder="0" aria-label="Quantity for product ${index + 1}"/>
            <div class="help">Enter a whole number (min 1)</div>
          </div>
        </div>
      `;
      return wrap;
    };

    const initChoicesForSelects = () => {
      $$('select').forEach(sel=>{
        if (sel.dataset.choicesInit) return; // avoid double-init
        new Choices(sel, {
          searchEnabled:true,
          itemSelectText:'',
          shouldSort:false,
          placeholderValue:'--- Select a product ---',
          allowHTML:false
        });
        sel.dataset.choicesInit = '1';
        sel.addEventListener('change', ()=> { sel.setAttribute('value', sel.value || ''); });
      });
    };

    const toggleSubmitEnabled = () => {
      const hasOneValid = Array.from({length:maxItems}).some((_,i)=>{
        const prod = document.getElementById(`product${i}`);
        const qty  = document.getElementById(`quantity${i}`);
        return prod && qty && prod.value && qty.value && Number(qty.value) > 0;
      });
      const nameOk = document.getElementById('technician').value.trim().length > 0;
      const dateOk = !!dateInput.value;
      submitBtn.disabled = !(hasOneValid && nameOk && dateOk);
    };

    const addVisibilityLogic = () => {
      for (let i=0; i<maxItems; i++){
        const qty = document.getElementById(`quantity${i}`);
        if (!qty) continue;
        qty.addEventListener('input', ()=>{
          const val = parseInt(qty.value,10);
          const next = productFields.children[i+1];
          if (next){
            next.style.display = (Number.isInteger(val) && val>0) ? 'block' : 'none';
          }
          if (i === maxItems-1){
            limitMessage.style.display = (Number.isInteger(val) && val>0) ? 'block' : 'none';
          }
          toggleSubmitEnabled();
        });
        const prod = document.getElementById(`product${i}`);
        if (prod){
          prod.addEventListener('change', toggleSubmitEnabled);
        }
      }
      document.getElementById('technician').addEventListener('input', toggleSubmitEnabled);
      dateInput.addEventListener('change', toggleSubmitEnabled);
    };

    const loadProducts = async () => {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;
        const res = await fetch(url, { cache: 'no-store' });
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const { cols, rows } = json.table;
    
        // --- Find Product column index robustly ---
        let prodIdx = cols.findIndex(c => (c?.label || '').toLowerCase().includes('item'));
        if (prodIdx === -1) {
          // Fallback: pick the column with the most non-empty cells
          const counts = cols.map((_, i) =>
            rows.reduce((acc, r) => acc + (r?.c?.[i]?.v ? 1 : 0), 0)
          );
          prodIdx = counts.indexOf(Math.max(...counts));
        }
    
        // --- Find Category column index robustly (defaults to column C / index 2) ---
        let catIdx = cols.findIndex(c => (c?.label || '').toLowerCase().includes('category'));
        if (catIdx === -1) catIdx = 2; // assume Column C if header not found
    
        // --- Build category → [products] map ---
        const categoryMap = {};
        rows.forEach(r => {
          const p = r?.c?.[prodIdx]?.v;
          if (!p) return;
          const cat = (r?.c?.[catIdx]?.v || 'Other').toString();
          if (!categoryMap[cat]) categoryMap[cat] = [];
          categoryMap[cat].push(p.toString());
        });
    
        // Sort categories and products for nicer UX
        const categories = Object.keys(categoryMap).sort((a, b) => a.localeCompare(b));
        for (const k of categories) {
          categoryMap[k].sort((a, b) => a.localeCompare(b));
        }
    
        // --- Build a single HTML string of <optgroup> blocks ---
        const optionsHTML = categories.map(cat => `
          <optgroup label="${cat.replaceAll('"','&quot;')}">
            ${categoryMap[cat]
              .map(p => `<option value="${p.replaceAll('"','&quot;')}">${p}</option>`)
              .join('')}
          </optgroup>
        `).join('');
    
        if (!optionsHTML.trim()) throw new Error('No products found in sheet');
    
        // Build 5 product blocks using the prepared HTML
        productFields.innerHTML = '';
        for (let i = 0; i < 5; i++) {
          productFields.appendChild(makeProductBlock(i, optionsHTML));
        }
    
        productFields.setAttribute('aria-busy', 'false');
        initChoicesForSelects();
        addVisibilityLogic();
        toggleSubmitEnabled();
      } catch (err) {
        console.error('Failed to load product list:', err);
        productFields.setAttribute('aria-busy', 'false');
        showMsg(formMsg, 'Failed to load product list. Please try again later.', 'error');
      }
    };

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      showMsg(formMsg, '', '');
      submitBtn.disabled = true;

      const data = new FormData(form);
      const payload = {
        technician: data.get('technician')?.trim(),
        date: data.get('date'),
        products: []
      };
      for (let i=0; i<5; i++){
        const product = data.get(`product${i}`);
        const quantity = data.get(`quantity${i}`);
        if (product && quantity && Number(quantity)>0){
          payload.products.push({ product, quantity: String(parseInt(quantity,10)) });
        }
      }

      if (!payload.products.length){
        showMsg(formMsg, 'Please select at least one product with a quantity of 1 or more.', 'warn');
        submitBtn.disabled = false;
        return;
      }

      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), 15000);
      try{
        const res = await fetch('https://hook.eu2.make.com/txaiit01opb9nhhre5ly9sju2a885ra4', {
          method:'POST',
          body: JSON.stringify(payload),
          headers:{ 'Content-Type':'application/json' },
          signal: controller.signal
        });
        clearTimeout(t);

        if (res.ok){
          showMsg(formMsg, 'Form submitted successfully!', 'ok');
          form.reset();
          for (let i=0; i<5; i++){
            const sel = document.getElementById(`product${i}`);
            const qty = document.getElementById(`quantity${i}`);
            if (sel){
              sel.value = '';
              sel.dispatchEvent(new Event('change',{bubbles:true}));
            }
            if (qty){ qty.value=''; }
            const block = productFields.children[i];
            block.style.display = i===0 ? 'block' : 'none';
          }
          limitMessage.style.display='none';
          dateInput.valueAsDate = new Date();
          toggleSubmitEnabled();
        }else{
          showMsg(formMsg, 'Something went wrong while submitting. Please try again.', 'error');
          submitBtn.disabled = false;
        }
      }catch(err){
        console.error(err);
        showMsg(formMsg, 'Network error or timeout. Please check your connection and try again.', 'error');
        submitBtn.disabled = false;
      }finally{
        clearTimeout(t);
      }
    });

    loadProducts();
  })();
  </script>
</body>
</html>
