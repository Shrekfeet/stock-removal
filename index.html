<script>
  const sheetID = '1Mbtodjvs9m1QgzQPX18j8FnmlAzfKxxbGx8O6XUkySI';
  const webhookURL = 'https://hook.eu2.make.com/skxfmwfapxg7v9t61j8jstf1rv02e7rd';

  const productFieldsContainer = document.getElementById('productFields');

  const createProductBlock = (index, productList) => {
    const div = document.createElement('div');
    div.className = 'product-block';
    div.style.display = index === 0 ? 'block' : 'none'; // Show only first block

    div.innerHTML = `
      <label>Product ${index + 1}
        <select name="product${index}">
          <option value="">-- Select a product --</option>
          ${productList.map(p => `<option value="${p}">${p}</option>`).join('')}
        </select>
      </label>
      <label>Quantity
        <input type="number" name="quantity${index}" min="1" />
      </label>
    `;
    return div;
  };

  async function loadProducts() {
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;
    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    const rows = json.table.rows;
    const products = rows.map(row => row.c[0]?.v).filter(Boolean);

    // Add 5 product + quantity sets
    for (let i = 0; i < 5; i++) {
      const block = createProductBlock(i, products);
      productFieldsContainer.appendChild(block);
    }

    addFieldVisibilityLogic();
  }

  function addFieldVisibilityLogic() {
    const blocks = document.querySelectorAll('.product-block');

    blocks.forEach((block, index) => {
      const qtyInput = block.querySelector(`input[name="quantity${index}"]`);
      if (qtyInput) {
        qtyInput.addEventListener('input', () => {
          const nextBlock = blocks[index + 1];
          if (nextBlock) {
            const shouldShow = qtyInput.value && parseInt(qtyInput.value) > 0;
            nextBlock.style.display = shouldShow ? 'block' : 'none';
          }
        });
      }
    });
  }

  loadProducts();

  document.getElementById('stockForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = new FormData(e.target);
    const payload = {
      technician: data.get('technician'),
      date: data.get('date'),
      products: []
    };

    for (let i = 0; i < 5; i++) {
      const product = data.get(`product${i}`);
      const quantity = data.get(`quantity${i}`);
      if (product && quantity) {
        payload.products.push({ product, quantity });
      }
    }

    const res = await fetch(webhookURL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (res.ok) {
      alert('Form submitted successfully!');
      e.target.reset();
      location.reload(); // reset visibility
    } else {
      alert('Something went wrong. Please try again.');
    }
  });
</script>
